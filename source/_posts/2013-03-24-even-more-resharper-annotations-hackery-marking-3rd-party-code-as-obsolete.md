---
title: 'Even more ReSharper Annotations hackery: marking 3rd party code as obsolete'
date: 2013-03-24T23:16:14+00:00
---
As part of transitioning to a new API, I wanted a way to mark the old API as obsolete, so that Visual Studio (or ReSharper) would flag using of the old API as an error.

<!-- more -->

Normally, the [`ObsoleteAttribute`](http://msdn.microsoft.com/en-us/library/system.obsoleteattribute.aspx) does exactly that &ndash; marks certain methods or types as obsolete, and has a constructor overload to specify whether the usage will be treated as an error or not. Unfortunately, in my case there was no source code for the old API (it was used as a 3<sup>rd</sup>-party DLL), and there's no way to apply the Obsolete attribute to external DLLs without modifying the assembly using IL-rewriting tools.

It had occurred to me that perhaps this would be possible to achieve using one of [ReSharper's External Annotations](http://www.jetbrains.com/resharper/webhelp/Code_Analysis__External_Annotations.html), but there are no built-in annotations for this kind of task. The annotations mechanism is used to decorate various .NET types and methods with special attributes that provide ReSharper with additional information. Turns out, it is possible to use the same mechanism to apply the Obsolete attribute as well! This way, ReSharper could mark the usage as an error, even if it's not really a compilation error (which is good enough for me!).

I [previously wrote](http://hmemcpy.com/2013/02/preventing-resharpers-implicitly-captured-closure-warning-in-fakeiteasy-unit-tests/) about how to add external annotations using XML files. According to ReSharper's documentation, external annotation XMLs can be placed in one of the following locations:

  * `[ReSharper install directory]\Bin\ExternalAnnotations\[Assembly name].xml` 
  * `[ReSharper install directory]\Bin\ExternalAnnotations\[Assembly name]\[Any name].xml`, where `[Assembly name]` is the assembly name without the version 
  * Alongside the assembly, named `[Assembly name].ExternalAnnotations.xml`

Since the old assembly was under my control, I chose the 3<sup>rd</sup> option, to place the annotations XML next to the assembly, and in the source control. This way, every team member that uses ReSharper will have this annotation enabled by simply updating to the latest source.

The external annotations XMLs are the same format as [XML documentation](http://msdn.microsoft.com/en-us/library/fsbx0t7x.aspx) files, generated by Visual Studio when you build your assembly. Supposing our assembly name is **`Acme.OldServiceBusImpl.dll`**, and the type we want to make obsolete is called **`EventBus`**, we need to create a file called **`Acme.OldServiceBusImpl.ExternalAnnotations.xml`**, and place it beside the DLL. The file has the following content:

```xml
<assembly name="Acme.OldEventBusImpl">
  <member name="T:Acme.OldEventBusImpl.EventBus">
    <attribute ctor="M:System.ObsoleteAttribute.#ctor(System.String,System.Boolean)">
      <argument>Use Acme.NewServiceBusImpl.ServiceBus instead.</argument>
      <argument>true</argument>
    </attribute>
  </member>
</assembly>
```

This specifies that for an assembly named `Acme.OldServiceBusImpl`, having a type `Acme.OldEventBusImpl.EventBus`, add an attribute instance of `ObsoleteAttribute` with the constructor overload [`ObsoleteAttribute(string, bool)`](http://msdn.microsoft.com/en-us/library/961hff5d.aspx), the boolean indicating the usage is considered an error.

After adding the XML file and reloading your project, ReSharper will now mark the usage of this type as an error! Your code will still compile, but [you'll get red on you](http://www.youtube.com/watch?v=j-n_yxJqYi0)!

<img title="" style="border-left-width: 0px; border-right-width: 0px; background-image: none; border-bottom-width: 0px; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border-top-width: 0px" border="0" alt="" src="http://i1.wp.com/hmemcpy.com/wp-content/uploads/2013/03/image6.png?resize=624%2C69" data-recalc-dims="1" />

Happy hacking!
